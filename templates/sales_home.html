{% extends 'base.html' %}
{% set hide_nav = true %}
{% set hide_sidebar = true %}
{% set show_hamburger = false %}
{% block content %}
<style>
  .sales-shell {
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 20px;
  }
  .sales-sidebar {
    background: #f7f9fb;
    border: 1px solid #e3e8ef;
    border-radius: 12px;
    padding: 16px;
    height: fit-content;
  }
  .sales-sidebar .title {
    font-weight: 600;
    color: #334155;
    margin-bottom: 12px;
  }
  .sales-nav {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .sales-nav li {
    margin-bottom: 8px;
  }
  .sales-nav a {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 8px;
    color: #0f172a;
    text-decoration: none;
    font-size: 0.92rem;
  }
  .sales-nav a:hover,
  .sales-nav a.active {
    background: #e8f0fe;
    color: #1d4ed8;
    font-weight: 600;
  }
  @media (max-width: 991px) {
    .sales-shell {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="sales-shell">
  <aside class="sales-sidebar">
    <div class="title">Sales</div>
    <ul class="sales-nav">
      <li><a href="/">Home</a></li>
      <li><a class="active" href="/sales">Sales Invoice</a></li>
      <li><a href="/sales#customer">Customers</a></li>
      <li><a href="/sales/reports">Reports</a></li>
    </ul>
  </aside>
  <div>
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <div>
        <h2 class="mb-1">Sales Invoice</h2>
        <div class="text-muted" style="font-size:0.95rem;">Create customers and invoices.</div>
      </div>
      {% if saved_invoice %}
        <div>
          <a class="btn btn-outline-success btn-sm" href="/sales/invoices/{{ saved_invoice.id }}/print" target="_blank">Print</a>
        </div>
      {% endif %}
    </div>

    <form method="get" action="/sales" class="mb-3">
      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label class="form-label" style="font-size:0.9rem;">Company</label>
          <select name="company_id" class="form-select form-select-sm" {% if session.get('role') == 'owner' %}disabled{% endif %}>
            <option value="">-- Company --</option>
            {% for c in companies %}
              <option value="{{ c.id }}" {% if selected_company_id and selected_company_id|int == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
          {% if session.get('role') == 'owner' %}
            <input type="hidden" name="company_id" value="{{ selected_company_id }}">
          {% endif %}
        </div>
        <div class="col-12 col-md-3" style="display:flex; align-items:end;">
          <button class="btn btn-outline-primary btn-sm w-100" type="submit">Load</button>
        </div>
      </div>
    </form>

    <div class="card mb-4" id="customer">
      <div class="card-body">
        <div class="fw-semibold mb-2">Customer</div>
        <form method="post" action="/sales">
          <input type="hidden" name="form_type" value="customer">
          <input type="hidden" name="company_id" value="{{ selected_company_id }}">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label" style="font-size:0.9rem;">Customer Name</label>
              <input name="customer_name" class="form-control form-control-sm" required>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" style="font-size:0.9rem;">Company Name</label>
              <input name="customer_company" class="form-control form-control-sm">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" style="font-size:0.9rem;">Email</label>
              <input name="customer_email" type="email" class="form-control form-control-sm">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" style="font-size:0.9rem;">Phone</label>
              <input name="customer_phone" class="form-control form-control-sm">
            </div>
            <div class="col-12">
              <label class="form-label" style="font-size:0.9rem;">Address</label>
              <input name="customer_address" class="form-control form-control-sm">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" style="font-size:0.9rem;">Tax Number</label>
              <input name="customer_tax" class="form-control form-control-sm">
            </div>
            <div class="col-12 col-md-4" style="display:flex; align-items:end;">
              <button class="btn btn-success btn-sm w-100" type="submit">Save Customer</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    {% if customers and customers|length > 0 %}
      <div class="card mb-4">
        <div class="card-body">
          <div class="fw-semibold mb-2">Existing Customers</div>
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Name</th>
                <th>Company</th>
                <th>Email</th>
                <th class="text-end">Edit</th>
              </tr>
            </thead>
            <tbody>
              {% for c in customers %}
                <tr>
                  <td>{{ c.name }}</td>
                  <td>{{ c.company_name or '' }}</td>
                  <td>{{ c.email or '' }}</td>
                  <td class="text-end">
                    <a class="btn btn-outline-primary btn-sm" href="/sales/customers/{{ c.id }}/edit">Edit</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    <div class="card mb-4" id="invoice">
      <div class="card-body">
        <div class="fw-semibold mb-2">Invoice</div>
        <form method="post" action="/sales" id="invoice-form">
          <input type="hidden" name="form_type" value="invoice">
          <input type="hidden" name="company_id" value="{{ selected_company_id }}">
          <input type="hidden" name="invoice_lines_json" id="invoice_lines_json">
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <label class="form-label" style="font-size:0.9rem;">Customer</label>
              <select name="customer_id" class="form-select form-select-sm" required>
                <option value="">-- Customer --</option>
                {% for c in customers %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" style="font-size:0.9rem;">Invoice Date</label>
              <input name="invoice_date" type="date" class="form-control form-control-sm" required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" style="font-size:0.9rem;">Due Date</label>
              <input name="due_date" type="date" class="form-control form-control-sm">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" style="font-size:0.9rem;">Terms</label>
              <select name="terms" class="form-select form-select-sm">
                <option value="Net 30">Net 30</option>
                <option value="Net 15">Net 15</option>
                <option value="Due on receipt">Due on receipt</option>
              </select>
            </div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-sm align-middle" id="invoice-lines">
              <thead style="background:#eef3f8;">
                <tr>
                  <th>Service</th>
                  <th>Description</th>
                  <th class="text-end" style="width:90px;">Qty</th>
                  <th class="text-end" style="width:120px;">Rate</th>
                  <th class="text-center" style="width:90px;">Tax</th>
                  <th class="text-end" style="width:120px;">Amount</th>
                  <th style="width:40px;"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-outline-secondary btn-sm" type="button" id="add-line">Add line</button>
          </div>

          <div class="row">
            <div class="col-12 col-md-6">
              <label class="form-label" style="font-size:0.9rem;">Message on invoice</label>
              <textarea name="message" class="form-control form-control-sm" rows="3"></textarea>
              <label class="form-label mt-2" style="font-size:0.9rem;">Message on statement</label>
              <textarea name="statement_message" class="form-control form-control-sm" rows="3"></textarea>
            </div>
            <div class="col-12 col-md-6">
              <div class="d-flex justify-content-between"><span class="text-muted">Subtotal</span><strong id="subtotal">$0.00</strong></div>
              <div class="d-flex justify-content-between"><span class="text-muted">HST (13%)</span><strong id="tax">$0.00</strong></div>
              <div class="d-flex justify-content-between border-top pt-2 mt-2"><span class="text-muted">Total</span><strong id="total">$0.00</strong></div>
            </div>
          </div>

          <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-success btn-sm" type="submit">Save Invoice</button>
          </div>
        </form>
      </div>
    </div>

    {% if invoices and invoices|length > 0 %}
      <div class="card">
        <div class="card-body">
          <div class="fw-semibold mb-2">Recent Invoices</div>
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Customer</th>
                <th class="text-end">Total</th>
                <th class="text-end">Edit</th>
                <th class="text-end">Print</th>
              </tr>
            </thead>
            <tbody>
              {% for inv in invoices %}
                <tr>
                  <td>{{ inv.id }}</td>
                  <td>{{ inv.invoice_date }}</td>
                  <td>{{ inv.customer.name if inv.customer else '' }}</td>
                  <td class="text-end">{{ (inv.total or 0) | money }}</td>
                  <td class="text-end"><a class="btn btn-outline-primary btn-sm" href="/sales/invoices/{{ inv.id }}/edit">Edit</a></td>
                  <td class="text-end"><a class="btn btn-outline-success btn-sm" href="/sales/invoices/{{ inv.id }}/print" target="_blank">Print</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
  const linesBody = document.querySelector('#invoice-lines tbody');
  const addLineBtn = document.getElementById('add-line');
  const subtotalEl = document.getElementById('subtotal');
  const taxEl = document.getElementById('tax');
  const totalEl = document.getElementById('total');
  const linesInput = document.getElementById('invoice_lines_json');

  const money = (value) => `$${value.toFixed(2)}`;

  const recalc = () => {
    let subtotal = 0;
    let tax = 0;
    const lines = [];
    linesBody.querySelectorAll('tr').forEach((row) => {
      const service = row.querySelector('[name="service"]').value;
      const description = row.querySelector('[name="description"]').value;
      const qty = parseFloat(row.querySelector('[name="qty"]').value || '0');
      const rate = parseFloat(row.querySelector('[name="rate"]').value || '0');
      const taxable = row.querySelector('[name="taxable"]').checked;
      const amount = qty * rate;
      const taxAmount = taxable ? amount * 0.13 : 0;
      subtotal += amount;
      tax += taxAmount;
      row.querySelector('.line-amount').textContent = money(amount);
      lines.push({ service, description, qty, rate, taxable });
    });
    subtotalEl.textContent = money(subtotal);
    taxEl.textContent = money(tax);
    totalEl.textContent = money(subtotal + tax);
    linesInput.value = JSON.stringify(lines);
  };

  const addLine = () => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input name="service" class="form-control form-control-sm"></td>
      <td><input name="description" class="form-control form-control-sm"></td>
      <td><input name="qty" type="number" step="0.01" class="form-control form-control-sm text-end"></td>
      <td><input name="rate" type="number" step="0.01" class="form-control form-control-sm text-end"></td>
      <td class="text-center"><input name="taxable" type="checkbox" checked></td>
      <td class="text-end line-amount">$0.00</td>
      <td class="text-end"><button class="btn btn-outline-danger btn-sm" type="button">Ã—</button></td>
    `;
    row.querySelectorAll('input').forEach((input) => input.addEventListener('input', recalc));
    row.querySelector('button').addEventListener('click', () => {
      row.remove();
      recalc();
    });
    linesBody.appendChild(row);
  };

  addLineBtn.addEventListener('click', () => {
    addLine();
    recalc();
  });

  addLine();
  recalc();
</script>
{% endblock %}
