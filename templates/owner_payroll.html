{% extends 'base.html' %}
{% block content %}
<h2>Payroll</h2>
<div class="text-muted" style="font-size:0.95rem; margin-top:-0.25rem; margin-bottom:1rem;">Submit pay date and hours. Admin will process and publish paystubs.</div>

<form method="post" class="mb-4">
  <div class="row g-2 align-items-end">
    <div class="col-12 col-lg-6">
      <label class="form-label" style="font-size:0.9rem;">Employee</label>
      <select name="employee_id" class="form-select form-select-sm" required>
        <option value="">-- Select employee --</option>
        {% for e in employees %}
          <option value="{{ e.id }}">{{ (e.first_name ~ ' ' ~ e.last_name).strip() }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-4 col-lg-3">
      <label class="form-label" style="font-size:0.9rem;">Period start</label>
      <input name="period_start" type="date" class="form-control form-control-sm">
    </div>
    <div class="col-12 col-md-4 col-lg-3">
      <label class="form-label" style="font-size:0.9rem;">Period end</label>
      <input name="period_end" type="date" class="form-control form-control-sm">
    </div>
    <div class="col-12 col-md-4 col-lg-3">
      <label class="form-label" style="font-size:0.9rem;">Pay date</label>
      <input name="pay_date" type="date" class="form-control form-control-sm" required>
    </div>
    <div class="col-12 col-md-4 col-lg-2">
      <label class="form-label" style="font-size:0.9rem;">Hours</label>
      <input name="hours" type="number" step="0.01" min="0" class="form-control form-control-sm" placeholder="0" required>
    </div>
    <div class="col-12 col-md-4 col-lg-1">
      <button class="btn btn-primary btn-sm w-100">Send</button>
    </div>
  </div>
</form>

<div class="card card-accent">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div style="font-weight:600;">Submissions</div>
    </div>

    {% if submissions %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Submitted</th>
              <th>Employee</th>
              <th>Period</th>
              <th>Pay date</th>
              <th class="text-end">Hours</th>
              <th>Status</th>
              <th>Paystub</th>
            </tr>
          </thead>
          <tbody>
            {% for s in submissions %}
              <tr>
                <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M') if s.created_at else '' }}</td>
                <td>{{ (s.employee.first_name ~ ' ' ~ s.employee.last_name).strip() if s.employee else '' }}</td>
                <td>
                  {% if s.period_start and s.period_end %}
                    {{ s.period_start.strftime('%Y-%m-%d') }} to {{ s.period_end.strftime('%Y-%m-%d') }}
                  {% elif s.period_start %}
                    From {{ s.period_start.strftime('%Y-%m-%d') }}
                  {% elif s.period_end %}
                    To {{ s.period_end.strftime('%Y-%m-%d') }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ s.pay_date.strftime('%Y-%m-%d') if s.pay_date else '' }}</td>
                <td class="text-end">{{ '%.2f'|format(s.hours or 0) }}</td>
                <td>
                  {% if s.status == 'processed' %}
                    <span class="badge text-bg-success">Processed</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Submitted</span>
                  {% endif %}
                </td>
                <td>
                  {% if s.status == 'processed' and s.payroll_line_id %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('paystub_pdf', payroll_line_id=s.payroll_line_id) }}">Download</a>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No submissions yet.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
