{% extends 'base.html' %}
{% set hide_header = true %}
{% set hide_nav = true %}
{% set hide_sidebar = true %}
{% set show_hamburger = true %}
{% block content %}
<h2>Run Payroll</h2>
<div class="text-muted" style="font-size:0.95rem; margin-top:-0.25rem; margin-bottom:1rem;">Enter total hours in Regular Pay. Vacation Pay defaults to 4%.</div>

<form method="post" class="mb-4">
  <div class="row g-2 align-items-end mb-3">
    <div class="col-12 col-md-4">
      <label class="form-label" style="font-size:0.9rem;">Period start</label>
      <input name="period_start" type="date" class="form-control form-control-sm">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label" style="font-size:0.9rem;">Period end</label>
      <input name="period_end" type="date" class="form-control form-control-sm">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label" style="font-size:0.9rem;">Pay date</label>
      <input name="pay_date" type="date" class="form-control form-control-sm" required>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0" id="payroll-table">
      <thead>
        <tr>
          <th style="width:40px;"><input type="checkbox" id="select-all" checked></th>
          <th>Employee</th>
          <th style="width:160px;">Regular Pay (hrs)</th>
          <th style="width:140px;">Vacation Pay</th>
          <th style="width:120px;">Total Hrs</th>
          <th style="width:140px;">Gross Pay</th>
        </tr>
      </thead>
      <tbody>
        {% for e in employees %}
          <tr>
            <td><input type="checkbox" name="include_{{ e.id }}" class="include-checkbox" checked></td>
            <td>{{ (e.first_name ~ ' ' ~ e.last_name).strip() }}</td>
            <td>
              <input name="hours_{{ e.id }}" type="number" step="0.01" min="0" class="form-control form-control-sm hours-input" placeholder="0" data-rate="{{ e.pay_rate or 0 }}" data-vac="{{ 1 if e.vacation_pay_enabled else 0 }}">
            </td>
            <td class="text-muted vac-col">{% if e.vacation_pay_enabled %}4%{% else %}-{% endif %}</td>
            <td class="total-hrs text-muted">0</td>
            <td class="gross-pay text-muted">$0.00</td>
          </tr>
        {% endfor %}
        <tr class="fw-semibold">
          <td></td>
          <td>Total</td>
          <td id="total-regular">0</td>
          <td></td>
          <td id="total-hrs">0</td>
          <td id="total-gross">$0.00</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary btn-sm">Submit Payroll</button>
    <button class="btn btn-outline-secondary btn-sm" type="submit" formaction="/owner/payroll/preview" formmethod="post">Preview</button>
  </div>
</form>

<script>
  const money = (value) => {
    const num = Number(value || 0);
    return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(num);
  };

  const updateTotals = () => {
    let totalRegular = 0;
    let totalHrs = 0;
    let totalGross = 0;
    document.querySelectorAll('#payroll-table tbody tr').forEach(row => {
      const hoursInput = row.querySelector('.hours-input');
      if (!hoursInput) return;
      const include = row.querySelector('.include-checkbox');
      if (include && !include.checked) {
        row.querySelector('.total-hrs').textContent = '0';
        row.querySelector('.gross-pay').textContent = money(0);
        return;
      }
      const hours = Number(hoursInput.value || 0);
      const rate = Number(hoursInput.dataset.rate || 0);
      const vacEnabled = Number(hoursInput.dataset.vac || 0) === 1;
      const regularPay = hours;
      const grossBase = hours * rate;
      const vacPay = vacEnabled ? grossBase * 0.04 : 0;
      const grossPay = grossBase + vacPay;
      row.querySelector('.total-hrs').textContent = hours.toFixed(2);
      row.querySelector('.gross-pay').textContent = money(grossPay);
      totalRegular += regularPay;
      totalHrs += hours;
      totalGross += grossPay;
    });
    const totalRegularEl = document.getElementById('total-regular');
    const totalHrsEl = document.getElementById('total-hrs');
    const totalGrossEl = document.getElementById('total-gross');
    if (totalRegularEl) totalRegularEl.textContent = totalRegular.toFixed(2);
    if (totalHrsEl) totalHrsEl.textContent = totalHrs.toFixed(2);
    if (totalGrossEl) totalGrossEl.textContent = money(totalGross);
  };

  const selectAll = document.getElementById('select-all');
  if (selectAll) {
    selectAll.addEventListener('change', () => {
      document.querySelectorAll('.include-checkbox').forEach(cb => {
        cb.checked = selectAll.checked;
      });
      updateTotals();
    });
  }

  document.querySelectorAll('.hours-input, .include-checkbox').forEach(el => {
    el.addEventListener('input', updateTotals);
    el.addEventListener('change', updateTotals);
  });

  updateTotals();
</script>

{% endblock %}
