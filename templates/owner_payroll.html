{% extends 'base.html' %}
{% block content %}
<h2>Payroll</h2>
<div class="text-muted" style="font-size:0.95rem; margin-top:-0.25rem; margin-bottom:1rem;">Select employees to include and enter hours. Uncheck to skip.</div>

<form method="post" class="mb-4">
  <div class="row g-2 align-items-end mb-3">
    <div class="col-12 col-md-4">
      <label class="form-label" style="font-size:0.9rem;">Period start</label>
      <input name="period_start" type="date" class="form-control form-control-sm">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label" style="font-size:0.9rem;">Period end</label>
      <input name="period_end" type="date" class="form-control form-control-sm">
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label" style="font-size:0.9rem;">Pay date</label>
      <input name="pay_date" type="date" class="form-control form-control-sm" required>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th style="width:40px;"><input type="checkbox" id="select-all" checked></th>
          <th>Employee</th>
          <th style="width:180px;">Hours</th>
        </tr>
      </thead>
      <tbody>
        {% for e in employees %}
          <tr>
            <td><input type="checkbox" name="include_{{ e.id }}" class="include-checkbox" checked></td>
            <td>{{ (e.first_name ~ ' ' ~ e.last_name).strip() }}</td>
            <td>
              <input name="hours_{{ e.id }}" type="number" step="0.01" min="0" class="form-control form-control-sm" placeholder="0">
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <button class="btn btn-primary btn-sm">Send</button>
  </div>
</form>

<script>
  const selectAll = document.getElementById('select-all');
  if (selectAll) {
    selectAll.addEventListener('change', () => {
      document.querySelectorAll('.include-checkbox').forEach(cb => {
        cb.checked = selectAll.checked;
      });
    });
  }
</script>

<div class="card card-accent">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div style="font-weight:600;">Submissions</div>
    </div>

    {% if submissions %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>Submitted</th>
              <th>Employee</th>
              <th>Period</th>
              <th>Pay date</th>
              <th class="text-end">Hours</th>
              <th>Status</th>
              <th>Paystub</th>
            </tr>
          </thead>
          <tbody>
            {% for s in submissions %}
              <tr>
                <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M') if s.created_at else '' }}</td>
                <td>{{ (s.employee.first_name ~ ' ' ~ s.employee.last_name).strip() if s.employee else '' }}</td>
                <td>
                  {% if s.period_start and s.period_end %}
                    {{ s.period_start.strftime('%Y-%m-%d') }} to {{ s.period_end.strftime('%Y-%m-%d') }}
                  {% elif s.period_start %}
                    From {{ s.period_start.strftime('%Y-%m-%d') }}
                  {% elif s.period_end %}
                    To {{ s.period_end.strftime('%Y-%m-%d') }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ s.pay_date.strftime('%Y-%m-%d') if s.pay_date else '' }}</td>
                <td class="text-end">{{ '%.2f'|format(s.hours or 0) }}</td>
                <td>
                  {% if s.status == 'processed' %}
                    <span class="badge text-bg-success">Processed</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Submitted</span>
                  {% endif %}
                </td>
                <td>
                  {% if s.status == 'processed' and s.payroll_line_id %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('paystub_pdf', payroll_line_id=s.payroll_line_id) }}">Download</a>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No submissions yet.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
